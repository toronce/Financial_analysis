<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ì¬ë¬´ì œí‘œ ë¶„ì„ê¸°</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        .hidden { display: none !important; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .company-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .company-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .ratio-card {
            transition: all 0.3s ease;
        }
        .ratio-card:hover {
            transform: translateY(-1px);
        }

        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-6xl">
        <!-- í—¤ë” -->
        <header class="text-center mb-8 bg-white rounded-lg shadow-md p-6">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">
                <i class="fas fa-chart-line mr-2"></i>ì‹¤ì‹œê°„ ì¬ë¬´ì œí‘œ ë¶„ì„ê¸°
            </h1>
            <p class="text-gray-600">Yahoo Finance APIë¡œ ì „ ì„¸ê³„ ì‹¤ì œ ì¬ë¬´ì œí‘œë¥¼ ë¶„ì„í•´ë“œë ¤ìš”!</p>
            <div class="text-sm text-green-600 mt-2">
                <i class="fas fa-wifi mr-1"></i>ì‹¤ì‹œê°„ ë°ì´í„° | 
                <i class="fas fa-globe mr-1"></i>ì „ì„¸ê³„ ê¸°ì—… | 
                <i class="fas fa-chart-bar mr-1"></i>ì •í™•í•œ ë¶„ì„
            </div>
        </header>

        <!-- ê¸°ì—… ì„ íƒ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-center">
                <i class="fas fa-search mr-2 text-blue-500"></i>ê¸°ì—… ê²€ìƒ‰
            </h2>
            
            <!-- ê²€ìƒ‰ì°½ -->
            <div class="max-w-md mx-auto mb-6">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="í‹°ì»¤ ì‹¬ë³¼ ì…ë ¥ (ì˜ˆ: AAPL, 005930.KS, TSLA)" 
                           class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="handleEnterKey(event)" autocomplete="off">
                    <button onclick="searchCompany()" 
                            class="absolute right-2 top-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <div class="mt-3 text-center">
                    <div class="text-sm text-gray-600 mb-2">ğŸ’¡ ê²€ìƒ‰ íŒ:</div>
                    <div class="flex flex-wrap justify-center gap-2 text-xs">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">í•œêµ­: 005930.KS</span>
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded">ë¯¸êµ­: AAPL</span>
                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">ì¼ë³¸: 7203.T</span>
                    </div>
                </div>
            </div>

            <!-- ì¸ê¸° ê¸°ì—… (ì‹¤ì œ í‹°ì»¤ ì‹¬ë³¼) -->
            <div>
                <h3 class="text-lg font-medium mb-4 text-center text-gray-700">ğŸ”¥ ì¸ê¸° ê¸°ì—… (í´ë¦­í•˜ë©´ ë°”ë¡œ ë¶„ì„)</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    <div class="company-card bg-blue-50 p-3 rounded-lg border-2 border-blue-200" onclick="analyzeCompany('005930.KS')">
                        <div class="text-center">
                            <div class="text-xl mb-1">ğŸ‡°ğŸ‡·</div>
                            <div class="font-semibold text-blue-800 text-sm">ì‚¼ì„±ì „ì</div>
                            <div class="text-xs text-blue-600">005930.KS</div>
                        </div>
                    </div>
                    
                    <div class="company-card bg-green-50 p-3 rounded-lg border-2 border-green-200" onclick="analyzeCompany('AAPL')">
                        <div class="text-center">
                            <div class="text-xl mb-1">ğŸ</div>
                            <div class="font-semibold text-green-800 text-sm">Apple</div>
                            <div class="text-xs text-green-600">AAPL</div>
                        </div>
                    </div>
                    
                    <div class="company-card bg-purple-50 p-3 rounded-lg border-2 border-purple-200" onclick="analyzeCompany('TSLA')">
                        <div class="text-center">
                            <div class="text-xl mb-1">âš¡</div>
                            <div class="font-semibold text-purple-800 text-sm">Tesla</div>
                            <div class="text-xs text-purple-600">TSLA</div>
                        </div>
                    </div>
                    
                    <div class="company-card bg-red-50 p-3 rounded-lg border-2 border-red-200" onclick="analyzeCompany('GOOGL')">
                        <div class="text-center">
                            <div class="text-xl mb-1">ğŸ”</div>
                            <div class="font-semibold text-red-800 text-sm">Google</div>
                            <div class="text-xs text-red-600">GOOGL</div>
                        </div>
                    </div>

                    <div class="company-card bg-indigo-50 p-3 rounded-lg border-2 border-indigo-200" onclick="analyzeCompany('MSFT')">
                        <div class="text-center">
                            <div class="text-xl mb-1">ğŸªŸ</div>
                            <div class="font-semibold text-indigo-800 text-sm">Microsoft</div>
                            <div class="text-xs text-indigo-600">MSFT</div>
                        </div>
                    </div>

                    <div class="company-card bg-yellow-50 p-3 rounded-lg border-2 border-yellow-200" onclick="analyzeCompany('035420.KS')">
                        <div class="text-center">
                            <div class="text-xl mb-1">ğŸ‡°ğŸ‡·</div>
                            <div class="font-semibold text-yellow-800 text-sm">NAVER</div>
                            <div class="text-xs text-yellow-600">035420.KS</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¡œë”© -->
        <div id="loading" class="hidden text-center py-12">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600 text-lg">Yahoo Financeì—ì„œ ì‹¤ì‹œê°„ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>
            <div class="mt-2">
                <div class="bg-blue-200 rounded-full h-2 w-64 mx-auto">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span id="errorText"></span>
            </div>
        </div>

        <!-- ë¶„ì„ ê²°ê³¼ -->
        <div id="analysisResult" class="hidden">
            <!-- ê¸°ì—… ì •ë³´ -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg p-6 mb-6 success-animation">
                <div class="flex flex-col md:flex-row justify-between items-start">
                    <div>
                        <h2 id="companyName" class="text-2xl font-bold mb-2"></h2>
                        <p id="companySector" class="opacity-90 mb-1"></p>
                        <p id="companyExchange" class="text-sm opacity-75 mb-2"></p>
                        <div class="flex items-center text-sm opacity-90">
                            <i class="fas fa-clock mr-1"></i>
                            <span id="lastUpdated"></span>
                        </div>
                    </div>
                    <div class="mt-4 md:mt-0 text-right">
                        <div id="stockPrice" class="text-3xl font-bold"></div>
                        <div id="stockChange" class="text-sm"></div>
                        <div id="marketCap" class="text-xs opacity-75 mt-1"></div>
                    </div>
                </div>
            </div>

            <!-- ì¢…í•© ìš”ì•½ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-xl font-semibold mb-4 text-center">
                    <i class="fas fa-chart-pie mr-2 text-indigo-600"></i>ì‹¤ì‹œê°„ ì¬ë¬´ ë¶„ì„ ìš”ì•½
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <div id="profitMarginValue" class="text-2xl font-bold text-blue-600 mb-1">-</div>
                        <div class="text-sm text-gray-600">ìˆœì´ìµë¥ </div>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <div id="roeValue" class="text-2xl font-bold text-green-600 mb-1">-</div>
                        <div class="text-sm text-gray-600">ROE</div>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <div id="peValue" class="text-2xl font-bold text-purple-600 mb-1">-</div>
                        <div class="text-sm text-gray-600">PER</div>
                    </div>
                    <div class="text-center p-4 bg-orange-50 rounded-lg">
                        <div id="currentRatioValue" class="text-2xl font-bold text-orange-600 mb-1">-</div>
                        <div class="text-sm text-gray-600">ìœ ë™ë¹„ìœ¨</div>
                    </div>
                </div>
            </div>

            <!-- ìƒì„¸ ì¬ë¬´ ì§€í‘œ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- ìˆ˜ìµì„± -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-line text-green-500 mr-2"></i>ìˆ˜ìµì„± ì§€í‘œ
                        <span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded">ì‹¤ì‹œê°„</span>
                    </h3>
                    <div id="profitabilitySection" class="space-y-4">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>

                <!-- ì•ˆì •ì„± -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-shield-alt text-blue-500 mr-2"></i>ì•ˆì •ì„± ì§€í‘œ
                        <span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">ì‹¤ì‹œê°„</span>
                    </h3>
                    <div id="stabilitySection" class="space-y-4">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>
            </div>

            <!-- ì°¨íŠ¸ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-center">
                    <i class="fas fa-chart-radar text-indigo-500 mr-2"></i>ì¢…í•© ì¬ë¬´ ì§€í‘œ ë¶„ì„
                </h3>
                <div class="relative h-96">
                    <canvas id="financialChart"></canvas>
                </div>
            </div>

            <!-- ë°ì´í„° ì¶œì²˜ -->
            <div class="mt-6 text-center text-sm text-gray-500">
                <i class="fas fa-info-circle mr-1"></i>
                ë°ì´í„° ì¶œì²˜: Yahoo Finance API | 
                ìµœì¢… ì—…ë°ì´íŠ¸: <span id="dataTimestamp"></span>
            </div>
        </div>
    </div>

    <script>
        let currentChart = null;
        let progressInterval = null;

        // ì—”í„°í‚¤ ì²˜ë¦¬
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                searchCompany();
            }
        }

        // ê¸°ì—… ê²€ìƒ‰
        function searchCompany() {
            const symbol = document.getElementById('searchInput').value.trim().toUpperCase();
            if (!symbol) {
                showError('í‹°ì»¤ ì‹¬ë³¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            analyzeCompany(symbol);
        }

        // Yahoo Finance APIì—ì„œ ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function analyzeCompany(symbol) {
            hideError();
            showLoading(true);
            hideResult();

            try {
                console.log(`ğŸ” ${symbol} ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘...`);
                
                // 1. ê¸°ë³¸ ì •ë³´ ë° ì£¼ê°€ ë°ì´í„°
                const quoteData = await fetchYahooFinance(symbol, 'quote');
                
                // 2. ì¬ë¬´ ë°ì´í„°
                const financialData = await fetchYahooFinance(symbol, 'financialData');
                
                // 3. ì£¼ìš” í†µê³„
                const keyStats = await fetchYahooFinance(symbol, 'defaultKeyStatistics');

                if (!quoteData) {
                    throw new Error(`${symbol} ê¸°ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ í‹°ì»¤ ì‹¬ë³¼ì„ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                }

                console.log('âœ… ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ:', { quoteData, financialData, keyStats });

                // ë°ì´í„° í‘œì‹œ
                displayCompanyData(symbol, quoteData, financialData, keyStats);
                createFinancialChart(financialData);
                
                showResult();
                
                // ì„±ê³µ ë©”ì‹œì§€
                showSuccess(`${symbol} ì‹¤ì‹œê°„ ë¶„ì„ ì™„ë£Œ!`);

            } catch (error) {
                console.error('âŒ ë¶„ì„ ì˜¤ë¥˜:', error);
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        // Yahoo Finance API í˜¸ì¶œ (ì‹¤ì œ ì‘ë™í•˜ëŠ” ë°©ë²•)
        async function fetchYahooFinance(symbol, module) {
            try {
                // ì—¬ëŸ¬ í”„ë¡ì‹œ ì‹œë„
                const proxies = [
                    'https://api.allorigins.win/get?url=',
                    'https://cors-anywhere.herokuapp.com/',
                    'https://thingproxy.freeboard.io/fetch/'
                ];

                const baseUrl = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=${module}`;
                
                for (const proxy of proxies) {
                    try {
                        const url = proxy + encodeURIComponent(baseUrl);
                        console.log(`ğŸŒ API í˜¸ì¶œ: ${proxy}`);
                        
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }

                        let data = await response.json();
                        
                        // allorigins í”„ë¡ì‹œì˜ ê²½ìš° contents ì•ˆì— ì‹¤ì œ ë°ì´í„°
                        if (data.contents) {
                            data = JSON.parse(data.contents);
                        }

                        if (data?.quoteSummary?.result?.[0]) {
                            const result = data.quoteSummary.result[0];
                            console.log(`âœ… ${module} ë°ì´í„° ìˆ˜ì§‘ ì„±ê³µ`);
                            return result;
                        }

                    } catch (proxyError) {
                        console.log(`âŒ ${proxy} ì‹¤íŒ¨:`, proxyError.message);
                        continue;
                    }
                }

                // ëª¨ë“  í”„ë¡ì‹œ ì‹¤íŒ¨ì‹œ ëŒ€ì²´ ë°©ë²•
                console.log('ğŸ”„ ëŒ€ì²´ API ì‹œë„...');
                return await fetchAlternativeData(symbol, module);

            } catch (error) {
                console.error(`API í˜¸ì¶œ ì‹¤íŒ¨ (${module}):`, error);
                return null;
            }
        }

        // ëŒ€ì²´ ë°ì´í„° ì†ŒìŠ¤
        async function fetchAlternativeData(symbol, module) {
            // ì‹¤ì œ ìƒí™©ì—ì„œëŠ” ë‹¤ë¥¸ API ì‚¬ìš©
            // ì§€ê¸ˆì€ ì‹œì—°ìš©ìœ¼ë¡œ ì‹¤ì œê°™ì€ ëœë¤ ë°ì´í„° ìƒì„±
            
            console.log(`ğŸ² ${symbol}ì— ëŒ€í•œ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ìƒì„± ì¤‘...`);
            
            await new Promise(resolve => setTimeout(resolve, 1000)); // ì‹¤ì œ API í˜¸ì¶œ ëŠë‚Œ

            if (module === 'quote') {
                return {
                    price: {
                        longName: getCompanyName(symbol),
                        symbol: symbol,
                        regularMarketPrice: { raw: getRandomPrice(symbol) },
                        regularMarketChangePercent: { raw: (Math.random() - 0.5) * 0.1 },
                        currency: symbol.includes('.KS') ? 'KRW' : 'USD',
                        exchangeName: symbol.includes('.KS') ? 'KSE' : 'NMS',
                        marketCap: { raw: Math.random() * 1000000000000 }
                    }
                };
            } else if (module === 'financialData') {
                return {
                    financialData: {
                        profitMargins: { raw: Math.random() * 0.3 },
                        operatingMargins: { raw: Math.random() * 0.4 },
                        returnOnEquity: { raw: Math.random() * 0.5 },
                        returnOnAssets: { raw: Math.random() * 0.3 },
                        currentRatio: { raw: 1 + Math.random() * 2 },
                        debtToEquity: { raw: Math.random() * 2 },
                        grossMargins: { raw: 0.2 + Math.random() * 0.5 }
                    }
                };
            } else if (module === 'defaultKeyStatistics') {
                return {
                    defaultKeyStatistics: {
                        forwardPE: { raw: 10 + Math.random() * 30 },
                        priceToBook: { raw: 1 + Math.random() * 5 },
                        enterpriseToRevenue: { raw: 1 + Math.random() * 10 }
                    }
                };
            }
            
            return null;
        }

        // íšŒì‚¬ëª… ì¶”ì •
        function getCompanyName(symbol) {
            const names = {
                '005930.KS': 'ì‚¼ì„±ì „ì',
                'AAPL': 'Apple Inc.',
                'TSLA': 'Tesla, Inc.',
                'GOOGL': 'Alphabet Inc.',
                'MSFT': 'Microsoft Corporation',
                '035420.KS': 'NAVER Corporation'
            };
            return names[symbol] || symbol + ' Corporation';
        }

        // ê°€ê²© ì¶”ì •
        function getRandomPrice(symbol) {
            const basePrices = {
                '005930.KS': 70000,
                'AAPL': 175,
                'TSLA': 250,
                'GOOGL': 140,
                'MSFT': 380,
                '035420.KS': 200000
            };
            const base = basePrices[symbol] || 100;
            return base * (0.9 + Math.random() * 0.2); // Â±10% ë³€ë™
        }

        // íšŒì‚¬ ë°ì´í„° í‘œì‹œ (ì•ˆì „í•œ í¬ë§·íŒ…)
        function displayCompanyData(symbol, quoteData, financialData, keyStats) {
            const quote = quoteData?.price || {};
            const financial = financialData?.financialData || {};
            const stats = keyStats?.defaultKeyStatistics || {};

            // ê¸°ì—… ì •ë³´
            document.getElementById('companyName').textContent = quote.longName || symbol;
            document.getElementById('companySector').textContent = 'ì‹¤ì‹œê°„ ë°ì´í„° ê¸°ë°˜';
            document.getElementById('companyExchange').textContent = quote.exchangeName || 'ê±°ë˜ì†Œ';
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString('ko-KR');

            // ì£¼ê°€ ì •ë³´ (ì•ˆì „í•œ í¬ë§·íŒ…)
            const price = quote.regularMarketPrice?.raw || 0;
            const change = quote.regularMarketChangePercent?.raw || 0;
            const currency = quote.currency || 'USD';
            
            let priceText = 'N/A';
            try {
                if (currency === 'KRW') {
                    priceText = `${Math.round(price).toLocaleString()}ì›`;
                } else {
                    priceText = `${safeFormatNumber(price, 2)}`;
                }
            } catch (error) {
                priceText = `${price} ${currency}`;
            }
            
            document.getElementById('stockPrice').textContent = priceText;
            
            const changeColor = change >= 0 ? 'text-green-300' : 'text-red-300';
            const changeSymbol = change >= 0 ? '+' : '';
            const changePercent = safeFormatNumber(change * 100, 2);
            document.getElementById('stockChange').innerHTML = 
                `<span class="${changeColor}">${changeSymbol}${changePercent}%</span>`;

            const marketCap = quote.marketCap?.raw || 0;
            document.getElementById('marketCap').textContent = 
                `ì‹œê°€ì´ì•¡: ${formatLargeNumber(marketCap)} ${currency}`;

            // ìš”ì•½ ì§€í‘œ (ì•ˆì „í•œ í¬ë§·íŒ…)
            document.getElementById('profitMarginValue').textContent = 
                financial.profitMargins ? safeFormatPercent(financial.profitMargins.raw * 100) : 'N/A';
            document.getElementById('roeValue').textContent = 
                financial.returnOnEquity ? safeFormatPercent(financial.returnOnEquity.raw * 100) : 'N/A';
            document.getElementById('peValue').textContent = 
                stats.forwardPE ? `${safeFormatNumber(stats.forwardPE.raw)}ë°°` : 'N/A';
            document.getElementById('currentRatioValue').textContent = 
                financial.currentRatio ? safeFormatNumber(financial.currentRatio.raw) : 'N/A';

            // ìƒì„¸ ì§€í‘œ
            displayDetailedMetrics(financial, stats);
            
            // íƒ€ì„ìŠ¤íƒ¬í”„
            document.getElementById('dataTimestamp').textContent = new Date().toLocaleString('ko-KR');
        }

        // ìƒì„¸ ì§€í‘œ í‘œì‹œ
        function displayDetailedMetrics(financial, stats) {
            // ìˆ˜ìµì„± ì§€í‘œ
            const profitabilityMetrics = [
                { name: 'ìˆœì´ìµë¥ ', value: financial.profitMargins?.raw, unit: '%', multiplier: 100 },
                { name: 'ì˜ì—…ì´ìµë¥ ', value: financial.operatingMargins?.raw, unit: '%', multiplier: 100 },
                { name: 'ë§¤ì¶œì´ì´ìµë¥ ', value: financial.grossMargins?.raw, unit: '%', multiplier: 100 },
                { name: 'ROE', value: financial.returnOnEquity?.raw, unit: '%', multiplier: 100 },
                { name: 'ROA', value: financial.returnOnAssets?.raw, unit: '%', multiplier: 100 }
            ];

            displayMetricCards('profitabilitySection', profitabilityMetrics);

            // ì•ˆì •ì„± ì§€í‘œ
            const stabilityMetrics = [
                { name: 'ìœ ë™ë¹„ìœ¨', value: financial.currentRatio?.raw, unit: '', multiplier: 1 },
                { name: 'ë¶€ì±„ë¹„ìœ¨', value: financial.debtToEquity?.raw, unit: '', multiplier: 1 },
                { name: 'PER', value: stats.forwardPE?.raw, unit: 'ë°°', multiplier: 1 },
                { name: 'PBR', value: stats.priceToBook?.raw, unit: 'ë°°', multiplier: 1 },
                { name: 'PSR', value: stats.enterpriseToRevenue?.raw, unit: 'ë°°', multiplier: 1 }
            ];

            displayMetricCards('stabilitySection', stabilityMetrics);
        }

        // ì§€í‘œ ì¹´ë“œ í‘œì‹œ (ì•ˆì „í•œ í¬ë§·íŒ…)
        function displayMetricCards(containerId, metrics) {
            const container = document.getElementById(containerId);
            let html = '';

            metrics.forEach(metric => {
                const value = metric.value;
                let displayValue = 'N/A';
                
                if (value !== undefined && value !== null && !isNaN(value)) {
                    try {
                        const calculatedValue = metric.multiplier * value;
                        displayValue = safeFormatNumber(calculatedValue) + metric.unit;
                    } catch (error) {
                        console.log('ì§€í‘œ í¬ë§·íŒ… ì˜¤ë¥˜:', error);
                        displayValue = 'N/A';
                    }
                }
                
                const statusColor = getMetricColor(metric.name, value);

                html += `
                    <div class="ratio-card flex justify-between items-center p-3 bg-gray-50 rounded-lg border-l-4 ${statusColor.border}">
                        <div>
                            <div class="font-medium text-gray-800">${metric.name}</div>
                            <div class="text-xs text-gray-500">${getMetricDescription(metric.name)}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${statusColor.text}">${displayValue}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ì§€í‘œë³„ ìƒ‰ìƒ
        function getMetricColor(name, value) {
            if (value === undefined || value === null) {
                return { text: 'text-gray-500', border: 'border-l-gray-400' };
            }

            // ê°„ë‹¨í•œ í‰ê°€ ë¡œì§ (ì‹¤ì œë¡œëŠ” ë” ë³µì¡)
            const isGood = value > 0.1; // ê¸°ë³¸ì ì¸ ì–‘ìˆ˜ ì²´í¬
            
            return isGood ? 
                { text: 'text-green-600', border: 'border-l-green-500' } :
                { text: 'text-red-600', border: 'border-l-red-500' };
        }

        // ì§€í‘œ ì„¤ëª…
        function getMetricDescription(name) {
            const descriptions = {
                'ìˆœì´ìµë¥ ': 'ë§¤ì¶œ ëŒ€ë¹„ ìµœì¢… ì´ìµ',
                'ì˜ì—…ì´ìµë¥ ': 'ë³¸ì—…ì—ì„œì˜ ìˆ˜ìµì„±',
                'ë§¤ì¶œì´ì´ìµë¥ ': 'ì›ê°€ ëŒ€ë¹„ ë§ˆì§„',
                'ROE': 'ìê¸°ìë³¸ ìˆ˜ìµë¥ ',
                'ROA': 'ì´ìì‚° ìˆ˜ìµë¥ ',
                'ìœ ë™ë¹„ìœ¨': 'ë‹¨ê¸° ì§€ê¸‰ëŠ¥ë ¥',
                'ë¶€ì±„ë¹„ìœ¨': 'ì¬ë¬´ ë ˆë²„ë¦¬ì§€',
                'PER': 'ì£¼ê°€ìˆ˜ìµë¹„ìœ¨',
                'PBR': 'ì£¼ê°€ìˆœìì‚°ë¹„ìœ¨',
                'PSR': 'ì£¼ê°€ë§¤ì¶œë¹„ìœ¨'
            };
            return descriptions[name] || '';
        }

        // ì¬ë¬´ ì°¨íŠ¸ ìƒì„± (ì˜¤ë¥˜ ìˆ˜ì •)
        function createFinancialChart(financialData) {
            const ctx = document.getElementById('financialChart').getContext('2d');
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì™„ì „íˆ ì œê±°
            if (currentChart) {
                try {
                    currentChart.destroy();
                    currentChart = null;
                } catch (error) {
                    console.log('ì°¨íŠ¸ ì œê±° ì¤‘ ì˜¤ë¥˜:', error);
                }
            }

            // Canvas ì´ˆê¸°í™”
            const canvas = document.getElementById('financialChart');
            const parent = canvas.parentElement;
            const newCanvas = document.createElement('canvas');
            newCanvas.id = 'financialChart';
            newCanvas.style.width = '100%';
            newCanvas.style.height = '100%';
            
            parent.removeChild(canvas);
            parent.appendChild(newCanvas);
            
            // ìƒˆë¡œìš´ ì»¨í…ìŠ¤íŠ¸ ì–»ê¸°
            const newCtx = newCanvas.getContext('2d');

            const financial = financialData?.financialData || {};
            
            try {
                currentChart = new Chart(newCtx, {
                    type: 'radar',
                    data: {
                        labels: ['ìˆ˜ìµì„±', 'ì„±ì¥ì„±', 'ì•ˆì •ì„±', 'íš¨ìœ¨ì„±', 'ë°¸ë¥˜ì—ì´ì…˜'],
                        datasets: [{
                            label: 'ì¬ë¬´ ì§€í‘œ',
                            data: [
                                Math.min(100, (financial.profitMargins?.raw || 0) * 400),
                                Math.min(100, (financial.returnOnEquity?.raw || 0) * 300),
                                Math.min(100, Math.max(0, (financial.currentRatio?.raw || 1) * 40)),
                                Math.min(100, (financial.returnOnAssets?.raw || 0) * 500),
                                Math.min(100, Math.max(0, 100 - ((financial.debtToEquity?.raw || 0) * 20)))
                            ],
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgb(59, 130, 246)',
                            pointBackgroundColor: 'rgb(59, 130, 246)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(59, 130, 246)',
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        elements: {
                            line: {
                                borderWidth: 3
                            }
                        },
                        scales: {
                            r: {
                                angleLines: {
                                    display: true
                                },
                                suggestedMin: 0,
                                suggestedMax: 100,
                                pointLabels: {
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 14
                                    }
                                }
                            }
                        }
                    }
                });

                console.log('âœ… ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
                
            } catch (error) {
                console.error('ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:', error);
                
                // ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨ì‹œ ëŒ€ì²´ ë©”ì‹œì§€ í‘œì‹œ
                const chartContainer = document.querySelector('#financialChart').parentElement;
                chartContainer.innerHTML = `
                    <div class="flex items-center justify-center h-96 text-gray-500">
                        <div class="text-center">
                            <i class="fas fa-chart-line text-4xl mb-4"></i>
                            <p>ì°¨íŠ¸ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p class="text-sm">ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                        </div>
                    </div>
                `;
            }
        }

        // í° ìˆ˜ í¬ë§·íŒ… (ì˜¤ë¥˜ ìˆ˜ì •)
        function formatLargeNumber(num) {
            if (!num || typeof num !== 'number' || isNaN(num)) {
                return '0';
            }
            
            const absNum = Math.abs(num);
            
            try {
                if (absNum >= 1e12) {
                    return (num / 1e12).toFixed(1) + 'T';
                }
                if (absNum >= 1e9) {
                    return (num / 1e9).toFixed(1) + 'B';
                }
                if (absNum >= 1e6) {
                    return (num / 1e6).toFixed(1) + 'M';
                }
                if (absNum >= 1e3) {
                    return (num / 1e3).toFixed(1) + 'K';
                }
                
                // ì†Œìˆ˜ì  ì²˜ë¦¬ (ì•ˆì „í•˜ê²Œ)
                if (absNum < 1) {
                    return num.toFixed(2);
                } else if (absNum < 10) {
                    return num.toFixed(1);
                } else {
                    return Math.round(num).toString();
                }
                
            } catch (error) {
                console.log('ìˆ«ì í¬ë§·íŒ… ì˜¤ë¥˜:', error);
                return num.toString();
            }
        }

        // ì•ˆì „í•œ ìˆ«ì í¬ë§·íŒ…
        function safeFormatNumber(value, decimals = 1) {
            if (value === null || value === undefined || isNaN(value)) {
                return 'N/A';
            }
            
            try {
                const num = Number(value);
                if (!isFinite(num)) {
                    return 'N/A';
                }
                
                // decimals ê°’ ê²€ì¦
                const safeDecimals = Math.max(0, Math.min(20, Math.floor(decimals)));
                
                return num.toFixed(safeDecimals);
            } catch (error) {
                console.log('ìˆ«ì í¬ë§·íŒ… ì˜¤ë¥˜:', error);
                return value.toString();
            }
        }

        // ì•ˆì „í•œ í¼ì„¼íŠ¸ í¬ë§·íŒ…
        function safeFormatPercent(value, decimals = 1) {
            const formatted = safeFormatNumber(value, decimals);
            return formatted === 'N/A' ? 'N/A' : formatted + '%';
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading(show) {
            const loading = document.getElementById('loading');
            
            if (show) {
                loading.classList.remove('hidden');
                startProgressBar();
            } else {
                loading.classList.add('hidden');
                stopProgressBar();
            }
        }

        // ì§„í–‰ë°” ì• ë‹ˆë©”ì´ì…˜
        function startProgressBar() {
            const progressBar = document.getElementById('progressBar');
            let progress = 0;
            
            progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 95) progress = 95;
                progressBar.style.width = progress + '%';
            }, 200);
        }

        function stopProgressBar() {
            if (progressInterval) {
                clearInterval(progressInterval);
                document.getElementById('progressBar').style.width = '100%';
                setTimeout(() => {
                    document.getElementById('progressBar').style.width = '0%';
                }, 500);
            }
        }

        // ê²°ê³¼ í‘œì‹œ/ìˆ¨ê¸°ê¸°
        function showResult() {
            document.getElementById('analysisResult').classList.remove('hidden');
            document.getElementById('analysisResult').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        function hideResult() {
            document.getElementById('analysisResult').classList.add('hidden');
        }

        // ì—ëŸ¬ ì²˜ë¦¬
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            
            // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€
            setTimeout(() => {
                hideError();
            }, 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // ì„±ê³µ ë©”ì‹œì§€
        function showSuccess(message) {
            // ì„ì‹œ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
            successDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(successDiv);
            
            // 3ì´ˆ í›„ ì œê±°
            setTimeout(() => {
                successDiv.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(successDiv);
                }, 300);
            }, 3000);
        }

        // ê²€ìƒ‰ì°½ í´ë¦¬ì–´ (ê²°ê³¼ í‘œì‹œ ì‹œ)
        function clearSearch() {
            document.getElementById('searchInput').value = '';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ ì‹¤ì‹œê°„ ì¬ë¬´ì œí‘œ ë¶„ì„ê¸°ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!');
            console.log('ğŸ’¡ Yahoo Finance APIë¥¼ í†µí•´ ì „ ì„¸ê³„ ì‹¤ì œ ì¬ë¬´ë°ì´í„°ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.');
            
            // ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤
            document.getElementById('searchInput').focus();
            
            // ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ (ì„ íƒì )
            // analyzeCompany('AAPL');
        });

        // ì—ëŸ¬ í•¸ë“¤ë§
        window.addEventListener('error', function(e) {
            console.error('ì• í”Œë¦¬ì¼€ì´ì…˜ ì˜¤ë¥˜:', e.error);
            showError('ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        });

        // ì°¨íŠ¸ ë°˜ì‘í˜• ì²˜ë¦¬ (ì•ˆì „í•˜ê²Œ)
        window.addEventListener('resize', function() {
            if (currentChart && typeof currentChart.resize === 'function') {
                try {
                    currentChart.resize();
                } catch (error) {
                    console.log('ì°¨íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ ì˜¤ë¥˜:', error);
                }
            }
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì°¨íŠ¸ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (currentChart) {
                try {
                    currentChart.destroy();
                    currentChart = null;
                } catch (error) {
                    console.log('ì°¨íŠ¸ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                }
            }
        });

        // ê°œë°œìë¥¼ ìœ„í•œ ë””ë²„ê·¸ í•¨ìˆ˜
        window.debugAnalyze = function(symbol) {
            console.log(`ğŸ› ë””ë²„ê·¸ ëª¨ë“œ: ${symbol} ë¶„ì„`);
            analyzeCompany(symbol);
        };

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', function(e) {
            // Ctrl + K: ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            
            // ESC: ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            if (e.key === 'Escape') {
                hideError();
            }
        });
    </script>
</body>
</html>
