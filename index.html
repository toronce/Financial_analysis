<!-- 검색 입력 -->
            <div class="max-w-md mx-auto mb-8">
                <div class="relative">
                    <input type="text" id="companySearch" placeholder="예: 삼성전자, 005930.KS, Apple, AAPL" 
                           class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="handleSearchKeyPress(event)" oninput="handleSearchInput(event)" autocomplete="off">
                    <button onclick="searchCompany()" 
                            class="absolute right-2 top-2 px-4 py-<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>자동 재무제표 분석기</title>
    
    <!-- CSS 라이브러리 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- JavaScript 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        .hidden { display: none !important; }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .ratio-card {
            transition: all 0.3s ease;
        }
        .ratio-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .search-result {
            transition: all 0.2s ease;
        }
        .search-result:hover {
            background-color: #f3f4f6;
        }
        
        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .grid-cols-3 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
            .text-3xl { font-size: 1.5rem; }
            .p-8 { padding: 1rem; }
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto p-4 max-w-7xl">
        <!-- 헤더 -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-robot text-blue-600 mr-2"></i>
                자동 재무제표 분석기
            </h1>
            <p class="text-gray-600">기업명만 입력하면 실시간 재무제표를 자동으로 분석해드려요!</p>
            <div class="mt-2 text-sm text-gray-500">
                🤖 Yahoo Finance API | 🌍 전세계 기업 지원 | 📊 실시간 분석
            </div>
        </header>

        <!-- 탭 메뉴 -->
        <div class="flex flex-wrap bg-white rounded-lg shadow-md mb-6 overflow-hidden">
            <button onclick="showTab('search')" id="tab-search" 
                    class="flex-1 min-w-0 py-3 px-4 text-sm font-medium bg-blue-600 text-white border-r border-gray-200 transition-colors">
                <i class="fas fa-search mr-1"></i>
                <span class="hidden sm:inline">기업 </span>검색
            </button>
            <button onclick="showTab('upload')" id="tab-upload" 
                    class="flex-1 min-w-0 py-3 px-4 text-sm font-medium text-gray-600 hover:bg-gray-50 border-r border-gray-200 transition-colors">
                <i class="fas fa-upload mr-1"></i>
                <span class="hidden sm:inline">파일 </span>업로드
            </button>
            <button onclick="showTab('analysis')" id="tab-analysis" 
                    class="flex-1 min-w-0 py-3 px-4 text-sm font-medium text-gray-600 hover:bg-gray-50 border-r border-gray-200 transition-colors">
                <i class="fas fa-calculator mr-1"></i>
                <span class="hidden sm:inline">재무 </span>분석
            </button>
            <button onclick="showTab('charts')" id="tab-charts" 
                    class="flex-1 min-w-0 py-3 px-4 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                <i class="fas fa-chart-bar mr-1"></i>
                <span class="hidden sm:inline">차트 </span>분석
            </button>
        </div>

        <!-- 기업 검색 탭 -->
        <div id="content-search" class="bg-white rounded-lg shadow-lg p-8">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">🔍</div>
                <h3 class="text-xl font-semibold mb-2">기업 검색 & 자동 분석</h3>
                <p class="text-gray-600 mb-6">기업명이나 티커 심볼을 입력하면 실시간 재무제표를 가져와서 분석해드려요</p>
            </div>

            <!-- 검색 입력 -->
            <div class="max-w-md mx-auto mb-8">
                <div class="relative">
                    <input type="text" id="companySearch" placeholder="예: 삼성전자, 005930.KS, Apple, AAPL" 
                           class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="handleSearchKeyPress(event)">
                    <button onclick="searchCompany()" 
                            class="absolute right-2 top-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- 인기 기업 -->
            <div class="mb-8">
                <h4 class="text-lg font-semibold mb-4 text-center">⚡ 빠른 분석</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 max-w-2xl mx-auto">
                    <button onclick="selectAndAnalyze('005930.KS')" class="p-3 bg-blue-100 hover:bg-blue-200 rounded-lg transition-colors">
                        <div class="font-semibold text-blue-800">삼성전자</div>
                        <div class="text-sm text-blue-600">005930.KS</div>
                    </button>
                    <button onclick="selectAndAnalyze('AAPL')" class="p-3 bg-green-100 hover:bg-green-200 rounded-lg transition-colors">
                        <div class="font-semibold text-green-800">Apple</div>
                        <div class="text-sm text-green-600">AAPL</div>
                    </button>
                    <button onclick="selectAndAnalyze('TSLA')" class="p-3 bg-purple-100 hover:bg-purple-200 rounded-lg transition-colors">
                        <div class="font-semibold text-purple-800">Tesla</div>
                        <div class="text-sm text-purple-600">TSLA</div>
                    </button>
                    <button onclick="selectAndAnalyze('GOOGL')" class="p-3 bg-red-100 hover:bg-red-200 rounded-lg transition-colors">
                        <div class="font-semibold text-red-800">Google</div>
                        <div class="text-sm text-red-600">GOOGL</div>
                    </button>
                </div>
            </div>

            <!-- 검색 결과 -->
            <div id="searchResults" class="hidden max-w-2xl mx-auto">
                <h4 class="text-lg font-semibold mb-4">검색 결과</h4>
                <div id="searchResultsList"></div>
            </div>

            <!-- 로딩 -->
            <div id="searchLoading" class="hidden text-center">
                <div class="inline-block">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>
                <p class="text-gray-600 mt-2">재무 데이터를 가져오는 중...</p>
            </div>

            <!-- 사용법 안내 -->
            <div class="grid md:grid-cols-2 gap-6 text-left mt-8">
                <div>
                    <h4 class="font-semibold mb-3 text-blue-800">
                        <i class="fas fa-lightbulb mr-2"></i>검색 팁
                    </h4>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li><i class="fas fa-check text-green-500 mr-2"></i><strong>한국 기업:</strong> 삼성전자, 네이버, 현대차</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i><strong>미국 기업:</strong> 애플, Apple, 구글</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i><strong>띄어쓰기:</strong> 삼성 전자, LG 화학</li>
                        <li><i class="fas fa-magic text-purple-500 mr-2"></i><strong>오타교정:</strong> 삼성젇나 → 삼성전자</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-semibold mb-3 text-green-800">
                        <i class="fas fa-chart-line mr-2"></i>분석 내용
                    </h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li><strong>수익성:</strong> 매출총이익률, ROE, ROA</li>
                        <li><strong>안정성:</strong> 부채비율, 유동비율</li>
                        <li><strong>성장성:</strong> 매출 성장률, 이익 성장률</li>
                        <li><strong>밸류에이션:</strong> PER, PBR</li>
                        <li><strong>실시간:</strong> 최신 재무 데이터</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 파일 업로드 탭 -->
        <div id="content-upload" class="hidden bg-white rounded-lg shadow-lg p-8">
            <div class="text-center">
                <div class="text-6xl mb-4">📤</div>
                <h3 class="text-xl font-semibold mb-2">직접 파일 업로드</h3>
                <p class="text-gray-600 mb-6">자체 재무제표 파일이 있으시면 업로드해서 분석하세요</p>
                
                <!-- 파일 업로드 영역 -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-6 hover:border-blue-400 transition-colors"
                     ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <input type="file" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)" 
                           id="file-upload" class="hidden">
                    <label for="file-upload" class="cursor-pointer">
                        <div class="text-gray-500 mb-2">
                            <i class="fas fa-cloud-upload-alt text-3xl mb-2"></i>
                            <p>파일을 여기에 드래그하거나 클릭하여 선택하세요</p>
                        </div>
                    </label>
                    <button onclick="document.getElementById('file-upload').click()" 
                            class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-folder-open mr-2"></i>파일 선택
                    </button>
                </div>
            </div>
        </div>

        <!-- 재무 분석 탭 -->
        <div id="content-analysis" class="hidden space-y-6">
            <!-- 기업 정보 카드 -->
            <div id="company-info" class="hidden bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                    <div>
                        <h2 id="company-name" class="text-2xl font-bold mb-2"></h2>
                        <p id="company-sector" class="opacity-90"></p>
                        <p id="company-market" class="text-sm opacity-75"></p>
                    </div>
                    <div class="mt-4 md:mt-0 text-right">
                        <div id="company-price" class="text-3xl font-bold"></div>
                        <div id="company-change" class="text-sm"></div>
                    </div>
                </div>
            </div>

            <!-- 종합 요약 -->
            <div id="summary-card" class="hidden bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4">📊 종합 분석 요약</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="summary-content">
                    <!-- 동적으로 생성 -->
                </div>
            </div>

            <!-- 수익성 분석 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4">
                    <i class="fas fa-chart-line text-green-600 mr-2"></i>수익성 분석
                </h3>
                <div class="bg-blue-50 p-4 rounded-lg mb-6">
                    <h4 class="font-semibold text-blue-800 mb-2">💡 수익성이란?</h4>
                    <p class="text-blue-700 text-sm">
                        기업이 얼마나 효율적으로 돈을 벌고 있는지를 보여주는 지표입니다. 
                        같은 매출이라도 비용을 적게 쓰고 더 많은 이익을 내는 회사가 수익성이 좋은 회사입니다.
                    </p>
                </div>
                <div id="profitability-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- 동적으로 생성 -->
                </div>
            </div>

            <!-- 안정성 분석 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4">
                    <i class="fas fa-shield-alt text-purple-600 mr-2"></i>안정성 분석
                </h3>
                <div class="bg-purple-50 p-4 rounded-lg mb-6">
                    <h4 class="font-semibold text-purple-800 mb-2">🛡️ 안정성이란?</h4>
                    <p class="text-purple-700 text-sm">
                        회사가 빚에 의존하지 않고 안전하게 운영되고 있는지를 보여줍니다. 
                        빚이 너무 많으면 이자 부담이 커져서 위험할 수 있어요.
                    </p>
                </div>
                <div id="stability-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- 동적으로 생성 -->
                </div>
            </div>

            <!-- 밸류에이션 분석 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4">
                    <i class="fas fa-tags text-orange-600 mr-2"></i>밸류에이션 분석
                </h3>
                <div class="bg-orange-50 p-4 rounded-lg mb-6">
                    <h4 class="font-semibold text-orange-800 mb-2">💰 밸류에이션이란?</h4>
                    <p class="text-orange-700 text-sm">
                        현재 주가가 기업의 실제 가치에 비해 비싼지 싼지를 판단하는 지표입니다. 
                        투자 결정에 중요한 참고 자료가 됩니다.
                    </p>
                </div>
                <div id="valuation-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- 동적으로 생성 -->
                </div>
            </div>
        </div>

        <!-- 차트 분석 탭 -->
        <div id="content-charts" class="hidden space-y-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4">
                    <i class="fas fa-chart-area text-indigo-600 mr-2"></i>재무 지표 비교
                </h3>
                <div class="relative" style="height: 400px;">
                    <canvas id="ratioChart"></canvas>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4">
                        <i class="fas fa-percentage text-green-600 mr-2"></i>수익성 지표
                    </h3>
                    <div class="relative" style="height: 300px;">
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4">
                        <i class="fas fa-balance-scale text-blue-600 mr-2"></i>밸류에이션
                    </h3>
                    <div class="relative" style="height: 300px;">
                        <canvas id="valuationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentCompanyData = null;
        let analysisData = null;
        let charts = {};

        // 기업명 → 티커 심볼 매핑 테이블
        const companyNameMap = {
            // 한국 기업 (다양한 표기법 포함)
            '삼성전자': '005930.KS',
            '삼성 전자': '005930.KS',
            'samsung': '005930.KS',
            'samsung electronics': '005930.KS',
            
            'sk하이닉스': '000660.KS',
            'sk 하이닉스': '000660.KS',
            'hynix': '000660.KS',
            
            '삼성바이오로직스': '207940.KS',
            '삼성 바이오로직스': '207940.KS',
            '삼성바이오': '207940.KS',
            
            '현대차': '005380.KS',
            '현대자동차': '005380.KS',
            '현대 자동차': '005380.KS',
            'hyundai': '005380.KS',
            
            'lg화학': '051910.KS',
            'lg 화학': '051910.KS',
            'lgchem': '051910.KS',
            
            '삼성sdi': '006400.KS',
            '삼성 sdi': '006400.KS',
            
            '네이버': '035420.KS',
            'naver': '035420.KS',
            
            '포스코홀딩스': '005490.KS',
            '포스코': '005490.KS',
            'posco': '005490.KS',
            
            '기아': '000270.KS',
            'kia': '000270.KS',
            
            '셀트리온': '068270.KS',
            'celltrion': '068270.KS',
            
            'sk이노베이션': '096770.KS',
            'sk 이노베이션': '096770.KS',
            
            'lg': '003550.KS',
            
            '한국전력': '015760.KS',
            '한국 전력': '015760.KS',
            'kepco': '015760.KS',
            
            'sk텔레콤': '017670.KS',
            'sk 텔레콤': '017670.KS',
            'skt': '017670.KS',
            
            'kt': '030200.KS',
            
            'lg전자': '066570.KS',
            'lg 전자': '066570.KS',
            
            'kb금융': '105560.KS',
            'kb 금융': '105560.KS',
            'kb': '105560.KS',
            
            '신한지주': '055550.KS',
            '신한': '055550.KS',
            
            '하나금융지주': '086790.KS',
            '하나금융': '086790.KS',
            '하나': '086790.KS',
            
            '카카오뱅크': '323410.KS',
            '카카오 뱅크': '323410.KS',
            
            // 미국 기업 (다양한 표기법 포함)
            '애플': 'AAPL',
            'apple': 'AAPL',
            
            '마이크로소프트': 'MSFT',
            '마이크로 소프트': 'MSFT',
            'microsoft': 'MSFT',
            'ms': 'MSFT',
            
            '구글': 'GOOGL',
            'google': 'GOOGL',
            'alphabet': 'GOOGL',
            '알파벳': 'GOOGL',
            
            '아마존': 'AMZN',
            'amazon': 'AMZN',
            
            '테슬라': 'TSLA',
            'tesla': 'TSLA',
            
            '메타': 'META',
            'meta': 'META',
            '페이스북': 'META',
            'facebook': 'META',
            
            '엔비디아': 'NVDA',
            'nvidia': 'NVDA',
            
            '넷플릭스': 'NFLX',
            'netflix': 'NFLX',
            
            'jp모건': 'JPM',
            'jpmorgan': 'JPM',
            'chase': 'JPM',
            
            '존슨앤존슨': 'JNJ',
            'johnson': 'JNJ',
            
            '비자': 'V',
            'visa': 'V',
            
            '월마트': 'WMT',
            'walmart': 'WMT',
            
            '마스터카드': 'MA',
            'mastercard': 'MA',
            
            '홈디포': 'HD',
            'homedepot': 'HD',
            'home depot': 'HD',
            
            '뱅크오브아메리카': 'BAC',
            'bank of america': 'BAC',
            'boa': 'BAC',
            
            '디즈니': 'DIS',
            'disney': 'DIS',
            
            '어도비': 'ADBE',
            'adobe': 'ADBE',
            
            '세일즈포스': 'CRM',
            'salesforce': 'CRM',
            
            '페이팔': 'PYPL',
            'paypal': 'PYPL',
            
            // 기타 글로벌 기업
            'asml': 'ASML',
            'tsmc': 'TSM',
            '대만반도체': 'TSM',
            'novo': 'NVO',
            '토요타': 'TM',
            'toyota': 'TM',
            '알리바바': 'BABA',
            'alibaba': 'BABA',
            '텐센트': 'TCEHY',
            'tencent': 'TCEHY',
            'unilever': 'UL',
            'novartis': 'NVS',
            'roche': 'RHHBY',
            'nestle': 'NESN.SW',
            '네슬레': 'NESN.SW',
            
            // 암호화폐 관련
            '코인베이스': 'COIN',
            'coinbase': 'COIN',
            '마이크로스트래티지': 'MSTR',
            'microstrategy': 'MSTR',
            'block': 'SQ',
            'riot': 'RIOT'
        };

        // Levenshtein Distance 계산 (오타 유사도)
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            const len1 = str1.length;
            const len2 = str2.length;

            // 빈 문자열 처리
            if (len1 === 0) return len2;
            if (len2 === 0) return len1;

            // 매트릭스 초기화
            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }

            // 거리 계산
            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,        // 삭제
                        matrix[i][j - 1] + 1,        // 삽입
                        matrix[i - 1][j - 1] + cost  // 대체
                    );
                }
            }

            return matrix[len1][len2];
        }

        // 유사도 점수 계산 (0~100)
        function getSimilarityScore(str1, str2) {
            const maxLen = Math.max(str1.length, str2.length);
            if (maxLen === 0) return 100;
            
            const distance = levenshteinDistance(str1.toLowerCase(), str2.toLowerCase());
            return Math.round((1 - distance / maxLen) * 100);
        }

        // 기업명을 티커 심볼로 변환 (오타 교정 포함)
        function convertNameToSymbol(input) {
            const cleanInput = input.toLowerCase().trim().replace(/\s+/g, ' ');
            
            // 1. 정확한 매칭
            if (companyNameMap[cleanInput]) {
                return companyNameMap[cleanInput];
            }
            
            // 2. 공백 제거해서 재시도
            const noSpaceInput = cleanInput.replace(/\s/g, '');
            for (const [name, symbol] of Object.entries(companyNameMap)) {
                if (name.replace(/\s/g, '') === noSpaceInput) {
                    return symbol;
                }
            }
            
            // 3. 부분 매칭 (포함 관계)
            for (const [name, symbol] of Object.entries(companyNameMap)) {
                if (name.includes(cleanInput) || cleanInput.includes(name)) {
                    return symbol;
                }
            }
            
            // 4. 오타 교정 (유사도 기반)
            let bestMatch = null;
            let bestScore = 0;
            const minSimilarity = 60; // 최소 60% 유사도
            
            for (const [name, symbol] of Object.entries(companyNameMap)) {
                // 공백 제거한 버전도 비교
                const nameNoSpace = name.replace(/\s/g, '');
                const inputNoSpace = cleanInput.replace(/\s/g, '');
                
                // 원본과 비교
                const score1 = getSimilarityScore(cleanInput, name);
                // 공백 제거 버전과 비교
                const score2 = getSimilarityScore(inputNoSpace, nameNoSpace);
                
                const maxScore = Math.max(score1, score2);
                
                if (maxScore > bestScore && maxScore >= minSimilarity) {
                    bestScore = maxScore;
                    bestMatch = { name, symbol, score: maxScore };
                }
            }
            
            // 오타 교정 결과가 있으면 확인 후 사용
            if (bestMatch) {
                console.log(`🔧 오타 교정: "${input}" → "${bestMatch.name}" (유사도: ${bestMatch.score}%)`);
                
                // 유사도가 80% 이상이면 자동 교정
                if (bestMatch.score >= 80) {
                    return bestMatch.symbol;
                }
                // 60-79%면 사용자에게 확인
                else if (bestMatch.score >= 60) {
                    const confirmed = confirm(`"${bestMatch.name}"을(를) 찾으시나요?\n(유사도: ${bestMatch.score}%)`);
                    if (confirmed) {
                        return bestMatch.symbol;
                    }
                }
            }
            
            // 변환 실패시 원본 반환 (티커 심볼일 수도 있음)
            return input.toUpperCase();
        }

        // 검색 제안 기능 (오타 교정 포함)
        function getSuggestions(input) {
            const cleanInput = input.toLowerCase().trim();
            const suggestions = [];
            const suggestionMap = new Map(); // 중복 제거용
            
            // 1. 정확한 매칭 및 부분 매칭
            for (const [name, symbol] of Object.entries(companyNameMap)) {
                if (name.includes(cleanInput) || cleanInput.includes(name)) {
                    if (!suggestionMap.has(symbol)) {
                        suggestions.push({ name, symbol, type: '정확매칭', score: 100 });
                        suggestionMap.set(symbol, true);
                    }
                }
            }
            
            // 2. 오타 교정 제안 (정확한 매칭이 부족할 때만)
            if (suggestions.length < 3 && cleanInput.length >= 2) {
                const typoSuggestions = [];
                
                for (const [name, symbol] of Object.entries(companyNameMap)) {
                    if (!suggestionMap.has(symbol)) {
                        const nameNoSpace = name.replace(/\s/g, '');
                        const inputNoSpace = cleanInput.replace(/\s/g, '');
                        
                        const score1 = getSimilarityScore(cleanInput, name);
                        const score2 = getSimilarityScore(inputNoSpace, nameNoSpace);
                        const maxScore = Math.max(score1, score2);
                        
                        if (maxScore >= 50) { // 50% 이상 유사도
                            typoSuggestions.push({ name, symbol, type: '오타교정', score: maxScore });
                        }
                    }
                }
                
                // 유사도 순으로 정렬
                typoSuggestions.sort((a, b) => b.score - a.score);
                
                // 상위 몇 개만 추가
                suggestions.push(...typoSuggestions.slice(0, 3));
            }
            
            return suggestions.slice(0, 5); // 최대 5개만
        }

        // 탭 전환 기능
        function showTab(tabName) {
            const tabs = ['search', 'upload', 'analysis', 'charts'];
            
            tabs.forEach(tab => {
                const tabBtn = document.getElementById(`tab-${tab}`);
                const content = document.getElementById(`content-${tab}`);
                
                if (tab === tabName) {
                    tabBtn.className = 'flex-1 min-w-0 py-3 px-4 text-sm font-medium bg-blue-600 text-white border-r border-gray-200 transition-colors';
                    content.classList.remove('hidden');
                } else {
                    tabBtn.className = 'flex-1 min-w-0 py-3 px-4 text-sm font-medium text-gray-600 hover:bg-gray-50 border-r border-gray-200 transition-colors';
                    content.classList.add('hidden');
                }
            });
        }

        // 드롭다운에서 기업 선택 처리
        function handleCompanySelect(event) {
            const symbol = event.target.value;
            if (symbol) {
                analyzeCompany(symbol);
            }
        }

        // 직접 입력 토글
        function toggleCustomInput() {
            const customDiv = document.getElementById('customInputDiv');
            const btn = document.getElementById('customInputBtn');
            
            if (customDiv && btn) {
                if (customDiv.classList.contains('hidden')) {
                    customDiv.classList.remove('hidden');
                    btn.textContent = '목록에서 선택하기';
                    
                    // 안전하게 포커스
                    setTimeout(() => {
                        const customInput = document.getElementById('customCompanyInput');
                        if (customInput) {
                            customInput.focus();
                        }
                    }, 50);
                } else {
                    customDiv.classList.add('hidden');
                    btn.textContent = '다른 기업 직접 입력하기';
                    
                    // 제안 목록 숨기기
                    const suggestionsDiv = document.getElementById('searchSuggestions');
                    if (suggestionsDiv) {
                        suggestionsDiv.classList.add('hidden');
                    }
                }
            }
        }

        // 직접 입력 키 처리
        function handleCustomInputKeyPress(event) {
            if (event.key === 'Enter') {
                analyzeCustomCompany();
            }
        }

        // 검색 제안 처리
        function handleSearchSuggestions(event) {
            const input = event.target.value.trim();
            const suggestionsDiv = document.getElementById('searchSuggestions');
            
            if (input.length < 2) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            
            const suggestions = getSuggestions(input);
            
            if (suggestions.length === 0) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            
            let html = '';
            suggestions.forEach(suggestion => {
                const typeIcon = suggestion.type === '정확매칭' ? '✅' : '🔧';
                const scoreText = suggestion.type === '오타교정' ? ` (유사도: ${suggestion.score}%)` : '';
                
                html += `
                    <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200 last:border-b-0" 
                         onclick="selectSuggestion('${suggestion.symbol}', '${suggestion.name}')">
                        <div class="flex items-center justify-between">
                            <div class="font-medium text-gray-800">${typeIcon} ${suggestion.name}</div>
                            <div class="text-xs text-gray-500">${suggestion.type}</div>
                        </div>
                        <div class="text-sm text-gray-600">${suggestion.symbol}${scoreText}</div>
                    </div>
                `;
            });
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.classList.remove('hidden');
        }

        // 제안 선택
        function selectSuggestion(symbol, name) {
            const customInput = document.getElementById('customCompanyInput');
            const suggestionsDiv = document.getElementById('searchSuggestions');
            
            if (customInput) {
                customInput.value = name;
            }
            suggestionsDiv.classList.add('hidden');
            
            // 바로 분석 실행
            analyzeCompany(symbol);
        }

        // 직접 입력된 기업 분석 (기업명 변환 기능 추가)
        function analyzeCustomCompany() {
            const customInput = document.getElementById('customCompanyInput');
            if (!customInput) {
                alert('입력 필드를 찾을 수 없습니다.');
                return;
            }
            
            const userInput = customInput.value.trim();
            if (!userInput) {
                alert('기업명이나 티커 심볼을 입력해주세요.');
                return;
            }
            
            // 기업명을 티커 심볼로 변환
            const symbol = convertNameToSymbol(userInput);
            
            // 제안 목록 숨기기
            const suggestionsDiv = document.getElementById('searchSuggestions');
            if (suggestionsDiv) {
                suggestionsDiv.classList.add('hidden');
            }
            
            console.log(`입력: "${userInput}" → 변환된 심볼: "${symbol}"`);
            
            analyzeCompany(symbol);
        }

        // 빠른 분석 버튼 (드롭다운도 함께 선택)
        function selectAndAnalyze(symbol) {
            // 드롭다운에서 해당 기업 선택 (안전하게)
            const companySelect = document.getElementById('companySelect');
            if (companySelect) {
                companySelect.value = symbol;
            }
            // 분석 실행
            analyzeCompany(symbol);
        }

        // 검색 키 입력 처리 (기존 함수 유지)
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                searchCompany();
            }
        }

        // 기업 검색 (기존 함수 수정)
        function searchCompany() {
            const query = document.getElementById('customCompanyInput').value.trim();
            if (!query) {
                alert('기업명이나 티커 심볼을 입력해주세요.');
                return;
            }

            // 바로 분석 시도
            analyzeCompany(query);
        }

        // 기업 분석
        async function analyzeCompany(symbol) {
            showLoading(true);
            
            try {
                // 여러 API 엔드포인트에서 데이터 수집
                const [quoteData, financialData, statisticsData] = await Promise.all([
                    fetchYahooData(symbol, 'quoteSummary', 'price,summaryDetail'),
                    fetchYahooData(symbol, 'quoteSummary', 'financialData,defaultKeyStatistics'),
                    fetchYahooData(symbol, 'quoteSummary', 'summaryProfile,assetProfile')
                ]);

                if (!quoteData && !financialData) {
                    throw new Error('해당 기업의 데이터를 찾을 수 없습니다. 정확한 티커 심볼을 입력해주세요.');
                }

                // 데이터 통합
                currentCompanyData = {
                    symbol: symbol.toUpperCase(),
                    quote: quoteData,
                    financial: financialData,
                    profile: statisticsData
                };

                // 분석 실행
                performAnalysis(currentCompanyData);
                
                // 분석 탭으로 이동
                showTab('analysis');
                
                alert(`✅ ${symbol} 분석 완료!\n실시간 재무 데이터를 분석했습니다.`);
                
            } catch (error) {
                console.error('분석 오류:', error);
                alert('❌ ' + error.message + '\n\n💡 검색 팁:\n- 한국 기업: 005930.KS (삼성전자)\n- 미국 기업: AAPL (애플)');
            }
            
            showLoading(false);
        }

        // Yahoo Finance API 호출
        async function fetchYahooData(symbol, endpoint, modules) {
            try {
                const url = `https://query1.finance.yahoo.com/v10/finance/${endpoint}/${symbol}?modules=${modules}`;
                
                // CORS 우회를 위한 프록시 사용
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl);
                const data = await response.json();
                
                if (data.contents) {
                    const yahooData = JSON.parse(data.contents);
                    return yahooData.quoteSummary?.result?.[0];
                }
                
                return null;
            } catch (error) {
                console.error('API 호출 오류:', error);
                return null;
            }
        }

        // 재무 분석 수행
        function performAnalysis(companyData) {
            const financial = companyData.financial?.financialData || {};
            const statistics = companyData.financial?.defaultKeyStatistics || {};
            const quote = companyData.quote?.price || {};
            const summaryDetail = companyData.quote?.summaryDetail || {};

            // 기업 정보 표시
            displayCompanyInfo(companyData);

            // 재무 비율 계산
            const analysis = {
                profitability: {
                    profitMargins: financial.profitMargins?.raw * 100 || 0,
                    operatingMargins: financial.operatingMargins?.raw * 100 || 0,
                    returnOnEquity: financial.returnOnEquity?.raw * 100 || 0,
                    returnOnAssets: financial.returnOnAssets?.raw * 100 || 0,
                    grossMargins: financial.grossMargins?.raw * 100 || 0
                },
                stability: {
                    debtToEquity: financial.debtToEquity?.raw || 0,
                    currentRatio: financial.currentRatio?.raw || 0,
                    quickRatio: financial.quickRatio?.raw || 0
                },
                valuation: {
                    peRatio: summaryDetail.trailingPE?.raw || 0,
                    pbRatio: statistics.priceToBook?.raw || 0,
                    pegRatio: statistics.pegRatio?.raw || 0,
                    priceToSales: statistics.priceToSalesTrailing12Months?.raw || 0
                },
                marketCap: quote.marketCap?.raw || 0,
                price: quote.regularMarketPrice?.raw || 0,
                change: quote.regularMarketChangePercent?.raw * 100 || 0
            };

            analysisData = analysis;
            displayAnalysis(analysis);
            createCharts(analysis);
        }

        // 기업 정보 표시
        function displayCompanyInfo(companyData) {
            const quote = companyData.quote?.price || {};
            const profile = companyData.profile?.summaryProfile || {};
            
            const companyInfoDiv = document.getElementById('company-info');
            const companyName = document.getElementById('company-name');
            const companySector = document.getElementById('company-sector');
            const companyMarket = document.getElementById('company-market');
            const companyPrice = document.getElementById('company-price');
            const companyChange = document.getElementById('company-change');

            companyName.textContent = quote.longName || quote.shortName || companyData.symbol;
            companySector.textContent = profile.sector || '정보 없음';
            companyMarket.textContent = `${quote.exchangeName || ''} | ${companyData.symbol}`;
            
            const price = quote.regularMarketPrice?.raw || 0;
            const currency = quote.currency || 'USD';
            companyPrice.textContent = `${price.toLocaleString()} ${currency}`;
            
            const change = quote.regularMarketChangePercent?.raw * 100 || 0;
            const changeColor = change >= 0 ? 'text-green-300' : 'text-red-300';
            companyChange.innerHTML = `<span class="${changeColor}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</span>`;
            
            companyInfoDiv.classList.remove('hidden');
        }

        // 분석 결과 표시
        function displayAnalysis(analysis) {
            displaySummary(analysis);
            
            // 수익성 카드
            displayRatioCards('profitability-cards', [
                { title: '순이익률', value: analysis.profitability.profitMargins, unit: '%', good: 10, excellent: 20, description: '매출 대비 순이익 비율. 높을수록 효율적인 경영' },
                { title: '영업이익률', value: analysis.profitability.operatingMargins, unit: '%', good: 15, excellent: 25, description: '본업에서의 수익성. 핵심 사업 경쟁력을 나타냄' },
                { title: 'ROE', value: analysis.profitability.returnOnEquity, unit: '%', good: 10, excellent: 20, description: '자기자본 대비 순이익률. 주주 투자 효율성' },
                { title: 'ROA', value: analysis.profitability.returnOnAssets, unit: '%', good: 5, excellent: 15, description: '총자산 대비 순이익률. 자산 활용 효율성' },
                { title: '매출총이익률', value: analysis.profitability.grossMargins, unit: '%', good: 25, excellent: 40, description: '매출 대비 매출총이익 비율. 가격 경쟁력' }
            ]);

            // 안정성 카드
            displayRatioCards('stability-cards', [
                { title: '부채비율', value: analysis.stability.debtToEquity, unit: '', good: 1.0, excellent: 0.5, description: '부채 대비 자기자본 비율. 낮을수록 안전', reverse: true },
                { title: '유동비율', value: analysis.stability.currentRatio, unit: '', good: 1.5, excellent: 2.0, description: '단기 채무 상환 능력. 2.0 이상이면 안전' },
                { title: '당좌비율', value: analysis.stability.quickRatio, unit: '', good: 1.0, excellent: 1.5, description: '즉시 현금화 가능한 자산으로 단기 채무 상환 능력' }
            ]);

            // 밸류에이션 카드
            displayRatioCards('valuation-cards', [
                { title: 'PER', value: analysis.valuation.peRatio, unit: '배', good: 20, excellent: 15, description: '주가 대비 주당순이익. 낮을수록 저평가', reverse: true },
                { title: 'PBR', value: analysis.valuation.pbRatio, unit: '배', good: 2.0, excellent: 1.0, description: '주가 대비 주당순자산. 1.0 이하면 저평가', reverse: true },
                { title: 'PEG', value: analysis.valuation.pegRatio, unit: '', good: 1.5, excellent: 1.0, description: 'PER을 성장률로 나눈 값. 1.0 이하면 저평가', reverse: true },
                { title: 'PSR', value: analysis.valuation.priceToSales, unit: '배', good: 3.0, excellent: 1.0, description: '주가 대비 주당매출. 낮을수록 저평가', reverse: true }
            ]);
        }

        // 종합 요약 표시
        function displaySummary(analysis) {
            const summaryCard = document.getElementById('summary-card');
            const summaryContent = document.getElementById('summary-content');
            
            // 종합 점수 계산
            const profitScore = calculateScore(analysis.profitability.profitMargins, 10, 20);
            const stabilityScore = calculateScore(analysis.stability.currentRatio, 1.5, 2.0);
            const valuationScore = calculateScore(20 - analysis.valuation.peRatio, 5, 15); // PER는 낮을수록 좋음
            
            const overallScore = Math.round((profitScore + stabilityScore + valuationScore) / 3);
            
            summaryContent.innerHTML = `
                <div class="text-center">
                    <div class="text-3xl font-bold mb-2 text-blue-600">${overallScore}/100</div>
                    <div class="text-sm text-gray-600">종합 점수</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold mb-2 text-green-600">${getGrade(overallScore)}</div>
                    <div class="text-sm text-gray-600">재무 등급</div>
                </div>
                <div class="text-center">
                    <div class="text-xl font-bold mb-2 text-purple-600">${analysis.profitability.profitMargins.toFixed(1)}%</div>
                    <div class="text-sm text-gray-600">순이익률</div>
                </div>
                <div class="text-center">
                    <div class="text-xl font-bold mb-2 text-orange-600">${analysis.valuation.peRatio > 0 ? analysis.valuation.peRatio.toFixed(1) : 'N/A'}배</div>
                    <div class="text-sm text-gray-600">PER</div>
                </div>
            `;
            
            summaryCard.classList.remove('hidden');
        }

        // 점수 계산 함수
        function calculateScore(value, good, excellent) {
            if (value >= excellent) return 100;
            if (value >= good) return 70 + (value - good) / (excellent - good) * 30;
            if (value >= 0) return value / good * 70;
            return 0;
        }

        // 등급 계산 함수
        function getGrade(score) {
            if (score >= 90) return 'A+';
            if (score >= 80) return 'A';
            if (score >= 70) return 'B+';
            if (score >= 60) return 'B';
            if (score >= 50) return 'C+';
            if (score >= 40) return 'C';
            return 'D';
        }

        // 비율 카드 표시
        function displayRatioCards(containerId, ratios) {
            const container = document.getElementById(containerId);
            let html = '';

            ratios.forEach(ratio => {
                const status = getRatioStatus(ratio.value, ratio.good, ratio.excellent, ratio.reverse);
                const displayValue = typeof ratio.value === 'number' && ratio.value !== 0 ? 
                    ratio.value.toFixed(1) : 'N/A';
                
                html += `
                    <div class="ratio-card bg-white p-4 rounded-lg shadow-md border-l-4 ${status.borderColor}">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-700 text-sm">${ratio.title}</h4>
                            <i class="fas ${status.icon} ${status.color}"></i>
                        </div>
                        <div class="flex items-end gap-1 mb-2">
                            <span class="text-2xl font-bold ${status.color}">${displayValue}</span>
                            <span class="text-sm text-gray-500">${ratio.unit}</span>
                        </div>
                        <p class="text-xs text-gray-500 leading-tight">${ratio.description}</p>
                        ${ratio.value > 0 ? `
                        <div class="mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="${status.bgColor} h-2 rounded-full transition-all duration-500" 
                                     style="width: ${Math.min(100, Math.max(10, getProgressWidth(ratio.value, ratio.good, ratio.excellent, ratio.reverse)))}%"></div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 진행률 계산
        function getProgressWidth(value, good, excellent, reverse = false) {
            if (reverse) {
                // PER, PBR 등은 낮을수록 좋음
                if (value <= excellent) return 100;
                if (value <= good) return 70;
                return Math.max(20, 100 - (value / good) * 50);
            } else {
                // 일반적인 경우 높을수록 좋음
                if (value >= excellent) return 100;
                if (value >= good) return 70;
                return Math.max(10, (value / good) * 70);
            }
        }

        // 비율 상태 계산
        function getRatioStatus(value, good, excellent, reverse = false) {
            let isGood = false;
            
            if (reverse) {
                // 낮을수록 좋은 지표 (PER, 부채비율 등)
                isGood = value <= excellent || (value <= good && value > 0);
            } else {
                // 높을수록 좋은 지표
                isGood = value >= excellent || (value >= good && value > 0);
            }
            
            if (value === 0 || value === null || value === undefined) {
                return {
                    status: 'unknown',
                    color: 'text-gray-600',
                    icon: 'fa-question',
                    borderColor: 'border-l-gray-500',
                    bgColor: 'bg-gray-500'
                };
            }
            
            if (isGood) {
                if ((reverse && value <= excellent) || (!reverse && value >= excellent)) {
                    return {
                        status: 'excellent',
                        color: 'text-green-600',
                        icon: 'fa-arrow-up',
                        borderColor: 'border-l-green-500',
                        bgColor: 'bg-green-500'
                    };
                } else {
                    return {
                        status: 'good',
                        color: 'text-blue-600',
                        icon: 'fa-arrow-up',
                        borderColor: 'border-l-blue-500',
                        bgColor: 'bg-blue-500'
                    };
                }
            } else {
                return {
                    status: 'warning',
                    color: 'text-red-600',
                    icon: 'fa-arrow-down',
                    borderColor: 'border-l-red-500',
                    bgColor: 'bg-red-500'
                };
            }
        }

        // 차트 생성
        function createCharts(analysis) {
            // 기존 차트 제거
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // 종합 비율 차트
            const ratioCtx = document.getElementById('ratioChart').getContext('2d');
            charts.ratio = new Chart(ratioCtx, {
                type: 'radar',
                data: {
                    labels: ['수익성', '안정성', '성장성', '효율성', '밸류에이션'],
                    datasets: [{
                        label: '재무 지표',
                        data: [
                            Math.min(100, analysis.profitability.profitMargins * 5),
                            Math.min(100, analysis.stability.currentRatio * 50),
                            Math.min(100, analysis.profitability.returnOnEquity * 3),
                            Math.min(100, analysis.profitability.returnOnAssets * 5),
                            Math.min(100, Math.max(0, 100 - analysis.valuation.peRatio * 2))
                        ],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgb(59, 130, 246)',
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(59, 130, 246)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    elements: {
                        line: {
                            borderWidth: 3
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                display: false
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    }
                }
            });

            // 수익성 차트
            const profitCtx = document.getElementById('profitChart').getContext('2d');
            charts.profit = new Chart(profitCtx, {
                type: 'bar',
                data: {
                    labels: ['순이익률', '영업이익률', 'ROE', 'ROA'],
                    datasets: [{
                        label: '수익성 (%)',
                        data: [
                            analysis.profitability.profitMargins,
                            analysis.profitability.operatingMargins,
                            analysis.profitability.returnOnEquity,
                            analysis.profitability.returnOnAssets
                        ],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            'rgb(34, 197, 94)',
                            'rgb(59, 130, 246)',
                            'rgb(139, 92, 246)',
                            'rgb(245, 158, 11)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // 밸류에이션 차트
            const valuationCtx = document.getElementById('valuationChart').getContext('2d');
            charts.valuation = new Chart(valuationCtx, {
                type: 'doughnut',
                data: {
                    labels: ['적정 PER', '현재 PER 프리미엄'],
                    datasets: [{
                        data: [
                            Math.min(20, analysis.valuation.peRatio),
                            Math.max(0, analysis.valuation.peRatio - 20)
                        ],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgb(34, 197, 94)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 로딩 표시
        function showLoading(show) {
            const loading = document.getElementById('searchLoading');
            if (show) {
                loading.classList.remove('hidden');
            } else {
                loading.classList.add('hidden');
            }
        }

        // 파일 업로드 관련 함수들
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('border-blue-400', 'bg-blue-50');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('border-blue-400', 'bg-blue-50');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-blue-400', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        async function processFile(file) {
            if (file.size > 10 * 1024 * 1024) {
                alert('파일 크기가 너무 큽니다. 10MB 이하의 파일을 선택해주세요.');
                return;
            }

            showLoading(true);

            try {
                let parsedData;

                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer);
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    parsedData = XLSX.utils.sheet_to_json(worksheet);
                } else if (file.name.endsWith('.csv')) {
                    const text = await file.text();
                    const result = Papa.parse(text, { 
                        header: true, 
                        dynamicTyping: true,
                        skipEmptyLines: true
                    });
                    parsedData = result.data;
                } else {
                    throw new Error('지원하지 않는 파일 형식입니다.');
                }

                // 파일 데이터 분석 로직 (기존과 동일)
                analyzeFileData(parsedData);
                showTab('analysis');
                
            } catch (error) {
                console.error('파일 처리 오류:', error);
                alert('❌ ' + error.message);
            }

            showLoading(false);
        }

        function analyzeFileData(data) {
            // 기존 파일 분석 로직과 동일
            // ... (생략)
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            showTab('search');
            
            // 드롭다운 포커스 (안전하게)
            setTimeout(() => {
                const companySelect = document.getElementById('companySelect');
                if (companySelect) {
                    companySelect.focus();
                }
            }, 100);
            
            console.log('🤖 자동 재무제표 분석기가 준비되었습니다!');
            console.log('💡 팁: 드롭다운에서 기업을 선택하거나 직접 입력하세요!');
        });

        // 에러 핸들링
        window.addEventListener('error', function(e) {
            console.error('애플리케이션 오류:', e.error);
        });

        // 반응형 처리
        window.addEventListener('resize', function() {
            Object.values(charts).forEach(chart => {
                if (chart) chart.resize();
            });
        });
    </script>
</body>
</html>
